// Bunny Stream API Integration
const BUNNY_API_KEY = import.meta.env.VITE_BUNNY_STREAM_API_KEY
const LIBRARY_ID = import.meta.env.VITE_BUNNY_LIBRARY_ID
const CDN_HOSTNAME = import.meta.env.VITE_BUNNY_CDN_HOSTNAME

/**
 * Video URL'sini √ß√∂z√ºmle (backend API ile - yt-dlp)
 */
export async function resolveVideoURL(url) {
  try {
    console.log('üîç Video URL √ß√∂z√ºmleniyor (backend API)...')
    
    // Backend API'sine istek g√∂nder
    const API_URL = import.meta.env.VITE_BACKEND_API_URL || 'http://localhost:5000'
    
    const response = await fetch(`${API_URL}/api/resolve-url`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ video_url: url })
    })
    
    if (!response.ok) {
      // Backend yoksa veya hata varsa, basit √ß√∂z√ºmleme yap
      console.warn('‚ö†Ô∏è Backend API kullanƒ±lamƒ±yor, basit √ß√∂z√ºmleme yapƒ±lƒ±yor...')
      return simpleResolveURL(url)
    }
    
    const data = await response.json()
    
    if (data.success) {
      console.log(`‚úÖ URL √ß√∂z√ºmlendi (${data.platform}): ${data.resolved_url.substring(0, 60)}...`)
      return {
        success: true,
        url: data.resolved_url,
        platform: data.platform,
        title: data.title,
        duration: data.duration
      }
    } else {
      console.error('‚ùå URL √ß√∂z√ºmlenemedi:', data.error)
      // Fallback: basit √ß√∂z√ºmleme
      return simpleResolveURL(url)
    }
    
  } catch (error) {
    console.error('‚ùå URL √ß√∂z√ºmleme hatasƒ±:', error)
    // Fallback: basit √ß√∂z√ºmleme
    return simpleResolveURL(url)
  }
}

/**
 * Basit URL √ß√∂z√ºmleme (fallback)
 */
function simpleResolveURL(url) {
  console.log('üîÑ Basit URL √ß√∂z√ºmleme yapƒ±lƒ±yor...')
  
  // Mail.ru i√ßin
  if (url.includes('mail.ru')) {
    console.log('üìß Mail.ru URL tespit edildi')
    if (!url.includes('/video/embed/')) {
      const match = url.match(/\/video\/.*?\/(\d+)/)
      if (match) {
        const videoId = match[1]
        url = `https://my.mail.ru/video/embed/${videoId}`
        console.log(`‚úÖ Mail.ru embed URL'sine √ßevrildi: ${url}`)
      }
    }
    return { success: true, url: url, platform: 'mail.ru' }
  }
  
  // Sibnet i√ßin - Cloudflare Worker proxy kullan
  if (url.includes('sibnet.ru')) {
    console.log('üîç Sibnet URL tespit edildi')
    
    // Cloudflare Worker URL'si (.env'den al)
    const PROXY_URL = import.meta.env.VITE_VIDEO_PROXY_URL
    
    if (PROXY_URL) {
      console.log('‚úÖ Cloudflare Worker proxy kullanƒ±lacak')
      return {
        success: true,
        url: url,
        platform: 'sibnet',
        useProxy: true,
        proxyUrl: PROXY_URL
      }
    } else {
      console.warn('‚ö†Ô∏è Sibnet i√ßin backend API veya Cloudflare Worker gerekli!')
      console.warn('‚ö†Ô∏è Se√ßenekler:')
      console.warn('   1. Backend: python upload_api.py')
      console.warn('   2. Cloudflare Worker: wrangler deploy')
      return {
        success: false,
        error: 'Sibnet i√ßin backend API veya Cloudflare Worker gerekli',
        url: url
      }
    }
  }
  
  // Diƒüer platformlar
  return { success: true, url: url, platform: 'other' }
}

/**
 * Collection listele
 */
export async function listCollections() {
  try {
    const response = await fetch(
      `https://video.bunnycdn.com/library/${LIBRARY_ID}/collections`,
      {
        headers: {
          'AccessKey': BUNNY_API_KEY
        }
      }
    )
    
    if (!response.ok) {
      throw new Error('Collection listelenemedi')
    }
    
    const data = await response.json()
    return {
      success: true,
      collections: data.items || []
    }
  } catch (error) {
    console.error('List collections error:', error)
    return {
      success: false,
      error: error.message,
      collections: []
    }
  }
}

/**
 * ƒ∞sme g√∂re collection bul (TAM E≈ûLE≈ûME)
 */
export async function findCollectionByName(name) {
  try {
    const result = await listCollections()
    if (!result.success) {
      return null
    }
    
    // Tam e≈üle≈üme kontrol√º
    const collection = result.collections.find(c => c.name === name)
    return collection ? collection.guid : null
  } catch (error) {
    console.error('Find collection error:', error)
    return null
  }
}

/**
 * Collection bul veya olu≈ütur
 */
export async function getOrCreateCollection(name) {
  try {
    // √ñnce var mƒ± kontrol et
    const existingId = await findCollectionByName(name)
    if (existingId) {
      console.log(`‚úÖ Mevcut collection bulundu: ${name}`)
      return {
        success: true,
        collectionId: existingId,
        created: false
      }
    }
    
    // Yoksa olu≈ütur
    console.log(`üìÅ Yeni collection olu≈üturuluyor: ${name}`)
    return await createCollection(name)
  } catch (error) {
    console.error('Get or create collection error:', error)
    return {
      success: false,
      error: error.message
    }
  }
}

/**
 * Video'yu collection'a ta≈üƒ±
 */
export async function moveToCollection(videoId, collectionId) {
  try {
    const response = await fetch(
      `https://video.bunnycdn.com/library/${LIBRARY_ID}/videos/${videoId}`,
      {
        method: 'POST',
        headers: {
          'AccessKey': BUNNY_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          collectionId: collectionId
        })
      }
    )
    
    if (!response.ok) {
      throw new Error('Video ta≈üƒ±namadƒ±')
    }
    
    return {
      success: true
    }
  } catch (error) {
    console.error('Move to collection error:', error)
    return {
      success: false,
      error: error.message
    }
  }
}

/**
 * Download & Upload fallback (fetch ba≈üarƒ±sƒ±z olursa)
 */
async function uploadViaDownload(videoUrl, title, collectionId = '') {
  try {
    console.log('üì• Backend ile indiriliyor ve y√ºkleniyor...')
    
    const BACKEND_API_URL = import.meta.env.VITE_BACKEND_API_URL || 'http://localhost:5000'
    
    const response = await fetch(`${BACKEND_API_URL}/api/download-upload`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        video_url: videoUrl,
        title: title,
        collection_id: collectionId,
        library_id: LIBRARY_ID,
        api_key: BUNNY_API_KEY
      })
    })
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      throw new Error(errorData.error || 'Download & upload ba≈üarƒ±sƒ±z')
    }
    
    const data = await response.json()
    
    if (!data.success) {
      throw new Error(data.error || 'Download & upload ba≈üarƒ±sƒ±z')
    }
    
    console.log('‚úÖ Backend ile y√ºklendi:', data.videoId)
    
    return {
      success: true,
      videoId: data.videoId,
      collectionId: collectionId,
      embedUrl: `https://iframe.mediadelivery.net/embed/${LIBRARY_ID}/${data.videoId}`,
      data: data
    }
  } catch (error) {
    console.error('‚ùå Download & upload hatasƒ±:', error)
    throw error
  }
}

/**
 * Ba≈üka bir URL'den video aktar (geli≈ütirilmi≈ü + URL √ß√∂z√ºmleme)
 */
export async function uploadFromURL(videoUrl, title, animeName = null, collectionId = '') {
  try {
    // URL'yi √ß√∂z√ºmle (mail.ru, sibnet vb.)
    console.log('üîç Video URL √ß√∂z√ºmleniyor...')
    const resolveResult = await resolveVideoURL(videoUrl)
    if (!resolveResult.success) {
      throw new Error('URL √ß√∂z√ºmlenemedi: ' + resolveResult.error)
    }
    
    const resolvedUrl = resolveResult.url
    console.log(`‚úÖ URL √ß√∂z√ºmlendi (${resolveResult.platform}): ${resolvedUrl.substring(0, 60)}...`)
    
    // Anime adƒ± verilmi≈üse, collection bul veya olu≈ütur
    if (animeName && !collectionId) {
      const collResult = await getOrCreateCollection(animeName)
      if (collResult.success) {
        collectionId = collResult.collectionId
      }
    }
    
    console.log('üì§ Bunny.net\'e fetch isteƒüi g√∂nderiliyor...')
    console.log('  URL:', resolvedUrl.substring(0, 100) + '...')
    console.log('  Title:', title)
    console.log('  Collection ID:', collectionId || 'Yok (ana dizin)')
    
    // Sibnet i√ßin √∂zel headers ekle
    const fetchHeaders = {}
    if (resolvedUrl.includes('sibnet.ru')) {
      console.log('  üîß Sibnet i√ßin √∂zel headers ekleniyor...')
      fetchHeaders['User-Agent'] = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      fetchHeaders['Referer'] = 'https://video.sibnet.ru/'
    }
    
    const response = await fetch(
      `https://video.bunnycdn.com/library/${LIBRARY_ID}/videos/fetch`,
      {
        method: 'POST',
        headers: {
          'AccessKey': BUNNY_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          url: resolvedUrl, // √á√∂z√ºmlenmi≈ü URL kullan
          title: title,
          collectionId: collectionId,
          headers: fetchHeaders // √ñzel headers
        })
      }
    )
    
    console.log('üì• Bunny.net response:', response.status, response.statusText)
    
    if (!response.ok) {
      const errorText = await response.text()
      console.error('‚ùå Bunny.net fetch ba≈üarƒ±sƒ±z:', errorText)
      console.error('‚ùå Request details:')
      console.error('   URL:', resolvedUrl.substring(0, 100))
      console.error('   Title:', title)
      console.error('   Collection ID:', collectionId || 'Yok')
      
      // 403/400 hatasƒ± alƒ±rsak, download & upload metodunu dene
      if (response.status === 403 || response.status === 400) {
        console.log('‚ö†Ô∏è Fetch ba≈üarƒ±sƒ±z, download & upload deneniyor...')
        return await uploadViaDownload(resolvedUrl, title, collectionId)
      }
      
      throw new Error(`Bunny.net upload failed (${response.status}): ${errorText}`)
    }
    
    const data = await response.json()
    console.log('üì¶ Bunny.net response data:', JSON.stringify(data, null, 2))
    
    // Bunny fetch API farklƒ± field'lar d√∂nd√ºrebilir
    const videoId = data.guid || data.id || data.videoId || data.videoLibraryId
    console.log('üé¨ Video ID:', videoId || 'YOK!')
    
    if (!videoId) {
      console.error('‚ùå Video ID alƒ±namadƒ±!')
      console.error('Response keys:', Object.keys(data))
      console.error('Full response:', data)
      
      // Eƒüer success:true d√∂nm√º≈üse ama ID yoksa, bekle ve listeden bul
      if (data.success === true || response.status === 200) {
        console.log('‚è≥ Video ID bulunamadƒ±, 5 saniye bekleniyor...')
        await new Promise(resolve => setTimeout(resolve, 5000))
        
        // Son y√ºklenen videoyu bul
        console.log('üîç Son y√ºklenen video aranƒ±yor...')
        const videos = await listVideos(1, 10)
        if (videos && videos.items && videos.items.length > 0) {
          const latestVideo = videos.items[0]
          console.log('‚úÖ Son video bulundu:', latestVideo.guid)
          return {
            success: true,
            videoId: latestVideo.guid,
            collectionId: collectionId,
            embedUrl: `https://iframe.mediadelivery.net/embed/${LIBRARY_ID}/${latestVideo.guid}`,
            data: latestVideo
          }
        }
      }
      
      throw new Error('Video ID alƒ±namadƒ± ve video listesinde bulunamadƒ±')
    }
    
    // Collection'a eklenmemi≈üse manuel olarak ta≈üƒ±
    if (collectionId && videoId) {
      console.log('üì¶ Video collection\'a ta≈üƒ±nƒ±yor...')
      await moveToCollection(videoId, collectionId)
    }
    
    return {
      success: true,
      videoId: videoId,
      collectionId: collectionId,
      embedUrl: `https://iframe.mediadelivery.net/embed/${LIBRARY_ID}/${videoId}`,
      data: data
    }
  } catch (error) {
    console.error('Bunny upload error:', error)
    return {
      success: false,
      error: error.message
    }
  }
}

/**
 * Lokal dosyadan video y√ºkle (geli≈ütirilmi≈ü)
 */
export async function uploadVideoFile(file, title, animeName = null, collectionId = '', onProgress = null) {
  try {
    // Anime adƒ± verilmi≈üse, collection bul veya olu≈ütur
    if (animeName && !collectionId) {
      const collResult = await getOrCreateCollection(animeName)
      if (collResult.success) {
        collectionId = collResult.collectionId
      }
    }
    
    // 1. Video olu≈ütur
    const createPayload = { title }
    if (collectionId) {
      createPayload.collectionId = collectionId
    }
    
    const createResponse = await fetch(
      `https://video.bunnycdn.com/library/${LIBRARY_ID}/videos`,
      {
        method: 'POST',
        headers: {
          'AccessKey': BUNNY_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(createPayload)
      }
    )
    
    if (!createResponse.ok) {
      throw new Error('Video olu≈üturulamadƒ±')
    }
    
    const video = await createResponse.json()
    const videoId = video.guid
    
    // Collection'a eklenmemi≈üse manuel olarak ta≈üƒ±
    if (collectionId && !video.collectionId) {
      console.log('üì¶ Video collection\'a ta≈üƒ±nƒ±yor...')
      await moveToCollection(videoId, collectionId)
    }
    
    // 2. Dosyayƒ± y√ºkle (progress tracking ile)
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest()
      
      // Progress tracking
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable && onProgress) {
          const percentComplete = (e.loaded / e.total) * 100
          onProgress(percentComplete)
        }
      })
      
      xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
          resolve({
            success: true,
            videoId: videoId,
            embedUrl: `https://iframe.mediadelivery.net/embed/${LIBRARY_ID}/${videoId}`,
            thumbnailUrl: `https://vz-${CDN_HOSTNAME}/thumbnail/${videoId}.jpg`
          })
        } else {
          reject(new Error('Upload failed'))
        }
      })
      
      xhr.addEventListener('error', () => {
        reject(new Error('Network error'))
      })
      
      xhr.open('PUT', `https://video.bunnycdn.com/library/${LIBRARY_ID}/videos/${videoId}`)
      xhr.setRequestHeader('AccessKey', BUNNY_API_KEY)
      xhr.setRequestHeader('Content-Type', 'application/octet-stream')
      xhr.send(file)
    })
  } catch (error) {
    console.error('Bunny upload error:', error)
    return {
      success: false,
      error: error.message
    }
  }
}

/**
 * Video bilgilerini al
 */
export async function getVideoInfo(videoId) {
  try {
    const response = await fetch(
      `https://video.bunnycdn.com/library/${LIBRARY_ID}/videos/${videoId}`,
      {
        headers: {
          'AccessKey': BUNNY_API_KEY
        }
      }
    )
    
    if (!response.ok) {
      throw new Error('Video bulunamadƒ±')
    }
    
    return await response.json()
  } catch (error) {
    console.error('Get video info error:', error)
    return null
  }
}

/**
 * Video sil
 */
export async function deleteVideo(videoId) {
  try {
    const response = await fetch(
      `https://video.bunnycdn.com/library/${LIBRARY_ID}/videos/${videoId}`,
      {
        method: 'DELETE',
        headers: {
          'AccessKey': BUNNY_API_KEY
        }
      }
    )
    
    return {
      success: response.ok
    }
  } catch (error) {
    console.error('Delete video error:', error)
    return {
      success: false,
      error: error.message
    }
  }
}

/**
 * Collection (klas√∂r) olu≈ütur
 */
export async function createCollection(name) {
  try {
    const response = await fetch(
      `https://video.bunnycdn.com/library/${LIBRARY_ID}/collections`,
      {
        method: 'POST',
        headers: {
          'AccessKey': BUNNY_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name })
      }
    )
    
    if (!response.ok) {
      throw new Error('Collection olu≈üturulamadƒ±')
    }
    
    const data = await response.json()
    return {
      success: true,
      collectionId: data.guid,
      created: true
    }
  } catch (error) {
    console.error('Create collection error:', error)
    return {
      success: false,
      error: error.message
    }
  }
}

/**
 * T√ºm videolarƒ± listele
 */
export async function listVideos(page = 1, itemsPerPage = 100) {
  try {
    const response = await fetch(
      `https://video.bunnycdn.com/library/${LIBRARY_ID}/videos?page=${page}&itemsPerPage=${itemsPerPage}`,
      {
        headers: {
          'AccessKey': BUNNY_API_KEY
        }
      }
    )
    
    if (!response.ok) {
      throw new Error('Videolar listelenemedi')
    }
    
    return await response.json()
  } catch (error) {
    console.error('List videos error:', error)
    return null
  }
}
